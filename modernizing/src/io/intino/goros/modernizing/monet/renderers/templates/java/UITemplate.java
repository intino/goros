package io.intino.goros.modernizing.monet.renderers.templates.java;

import io.intino.itrules.template.Rule;
import io.intino.itrules.template.Template;

import java.util.ArrayList;
import java.util.List;

import static io.intino.itrules.template.condition.predicates.Predicates.*;
import static io.intino.itrules.template.outputs.Outputs.*;

public class UITemplate extends Template {

	public List<Rule> ruleSet() {
		List<Rule> rules = new ArrayList<>();
		rules.add(rule().condition(allTypes("ui", "routedispatcher")).output(literal("package ")).output(placeholder("package")).output(literal(".")).output(placeholder("module", "lowerCase")).output(literal(".box.ui.displays;\n\nimport ")).output(placeholder("package")).output(literal(".")).output(placeholder("module", "lowerCase")).output(literal(".box.ui.displays.templates.AppTemplate;\nimport io.intino.alexandria.ui.Soul;\n\npublic class RouteDispatcher extends AbstractRouteDispatcher {\n\n    @Override\n    public void dispatchHome(Soul soul) {\n        soul.currentLayer(AppTemplate.class).openHome();\n    }\n\n    @Override\n    public void dispatchError(Soul soul) {\n    }\n\n    @Override\n    public void dispatchSingleton(Soul soul, String name, String mode) {\n        AppTemplate display = soul.currentLayer(AppTemplate.class);\n        if (mode != null && mode.equals(\"undefined\")) mode = null;\n        boolean readonly = mode != null && !mode.equalsIgnoreCase(\"edit\");\n        ")).output(expression().output(placeholder("definition", "dispatchSingleton").multiple("\n"))).output(literal("\n    }\n\n    @Override\n    public void dispatchInstance(Soul soul, String name, String id, String view, String mode) {\n        AppTemplate display = soul.currentLayer(AppTemplate.class);\n        if (view != null && view.equals(\"undefined\")) view = null;\n        if (mode != null && mode.equals(\"undefined\")) mode = null;\n        boolean readonly = mode != null && !mode.equalsIgnoreCase(\"edit\");\n        ")).output(expression().output(placeholder("definition", "dispatchInstance").multiple("\n"))).output(literal("\n    }\n\n    @Override\n    public void dispatchTask(Soul soul, String name, String inbox, String task) {\n        AppTemplate display = soul.currentLayer(AppTemplate.class);\n        if (task != null && task.equals(\"undefined\")) task = null;\n        ")).output(expression().output(placeholder("definition", "dispatchTask").multiple("\n"))).output(literal("\n    }\n\n    @Override\n    public void dispatchTaskTray(Soul soul, String folder) {\n        soul.currentLayer(AppTemplate.class).openTaskTray(folder);\n    }\n\n    @Override\n    public void dispatchTaskBoard(Soul soul, String folder) {\n        soul.currentLayer(AppTemplate.class).openTaskBoard(folder);\n    }\n\n    @Override\n    public void dispatchRoles(Soul soul) {\n        soul.currentLayer(AppTemplate.class).openRoles();\n    }\n\n    @Override\n    public void dispatchTrash(Soul soul) {\n        soul.currentLayer(AppTemplate.class).openTrash();\n    }\n\n    @Override\n    public void dispatchNews(Soul soul) {\n        soul.currentLayer(AppTemplate.class).openNews();\n    }\n\n    @Override\n    public void dispatchDashboard(Soul soul) {\n        soul.currentLayer(AppTemplate.class).openDashboard();\n    }\n}")));
		rules.add(rule().condition(allTypes("ui", "app")).output(literal("package ")).output(placeholder("package")).output(literal(".")).output(placeholder("module", "lowerCase")).output(literal(".box.ui.displays.templates;\n\nimport ")).output(placeholder("package")).output(literal(".")).output(placeholder("module", "lowerCase")).output(literal(".box.")).output(placeholder("boxName", "firstUpperCase")).output(literal("Box;\nimport io.intino.alexandria.ui.displays.components.BlockConditional;\nimport org.monet.metamodel.*;\nimport org.monet.metamodel.internal.Ref;\nimport org.monet.space.kernel.agents.AgentSession;\nimport org.monet.space.kernel.components.layers.FederationLayer;\nimport org.monet.space.kernel.components.layers.TaskLayer;\nimport org.monet.space.kernel.constants.ApplicationInterface;\nimport org.monet.space.kernel.constants.Database;\nimport org.monet.space.kernel.model.Dictionary;\nimport org.monet.space.kernel.model.*;\nimport org.monet.space.office.ApplicationOffice;\nimport io.intino.goros.unit.box.ui.datasources.TaskInboxDatasource;\nimport io.intino.goros.unit.box.ui.datasources.TaskListDatasource.Inbox;\nimport io.intino.goros.unit.util.AccountHelper;\nimport io.intino.goros.unit.util.LayerHelper;\n\nimport java.time.Instant;\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.Objects;\n\nimport static java.util.Collections.emptyList;\n\npublic class AppTemplate extends AbstractAppTemplate<")).output(placeholder("boxName", "firstUpperCase")).output(literal("Box> {\n    private View current = null;\n    private boolean sessionClosedDialogOpened = false;\n    private Instant lastCheck;\n\n    public enum View { Dashboard, Roles, TaskTray, TaskBoard, News, Trash")).output(expression().output(literal(", ")).output(placeholder("definition", "declaration").multiple(", "))).output(literal(" }\n\n    public AppTemplate(")).output(placeholder("boxName", "firstUpperCase")).output(literal("Box box) {\n        super(box);\n    }\n\n    @Override\n    public void init() {\n        super.init();\n        if (!org.monet.space.kernel.model.BusinessUnit.getInstance().isInstalled()) {\n            notifier.redirect(session().browser().baseUrl() + \"/install\");\n            return;\n        }\n        box().unit().initSession(session());\n        initLoggedChecker();\n        reloadPage.onExecute(e -> notifier.redirect(session().browser().requestUrl()));\n        io.intino.goros.unit.util.DisplayHelper.initAgentSession(session());\n        io.intino.goros.unit.util.DisplayHelper.initContext(box().unit(), session(), Thread.currentThread().getId());\n        box().pushService().onLinkedToThread(session().client(), threadId -> {\n            io.intino.goros.unit.util.DisplayHelper.initContext(box().unit(), session(), threadId);\n            checkFederation();\n        });\n        box().notifier().onTaskCreated(this, this::refreshTasksCount);\n        box().notifier().onTaskAssigned(this, this::refreshTasksCount);\n        box().notifier().onTaskUnAssigned(this, this::refreshTasksCount);\n        box().notifier().onTaskStateChange(this, this::refreshTasksCount);\n        refresh();\n    }\n\n    @Override\n    public void refresh() {\n        super.refresh();\n        refreshDrawer();\n        taskTrayLink.address(path -> path.replace(\":folder\", \"Pendientes\"));\n        taskTrayIconLink.address(path -> path.replace(\":folder\", \"Pendientes\"));\n        taskBoardLink.address(path -> path.replace(\":folder\", \"Pendientes\"));\n        taskBoardIconLink.address(path -> path.replace(\":folder\", \"Pendientes\"));\n        newsLink.address(path -> path);\n        newsIconLink.address(path -> path);\n        dashboardLink.address(path -> path);\n        dashboardIconLink.address(path -> path);\n    }\n\n    @Override\n    public void remove() {\n        super.remove();\n        box().notifier().unTaskCreated(this);\n        box().notifier().unTaskAssigned(this);\n        box().notifier().unTaskUnAssigned(this);\n        box().notifier().unTaskStateChange(this);\n    }\n\n    public void embedded(boolean embedded) {\n        if (!embedded) return;\n        header.hide();\n        drawer.hide();\n    }\n\n    public void openHome() {\n        Distribution distribution = BusinessUnit.getInstance().getDistribution();\n        Distribution.ShowProperty showProperty = distribution.getShow();\n        if (false) {}\n        ")).output(expression().output(placeholder("definition", "openHome").multiple("\n"))).output(literal("\n        else openForbiddenPage();\n    }\n\n    ")).output(expression().output(placeholder("definition", "method").multiple("\n"))).output(literal("\n\n    public void openForbiddenPage() {\n        loading.visible(false);\n        forbiddenPage.show();\n    }\n\n    public void openDashboard() {\n        if (initializationTaskOpened()) return;\n        openView(View.Dashboard);\n        if (dashboardPage.dashboardStamp != null) dashboardPage.dashboardStamp.refresh();\n    }\n\n    public void openRoles() {\n        if (initializationTaskOpened()) return;\n        openView(View.Roles);\n        if (rolesPage.rolesStamp != null) rolesPage.rolesStamp.refresh();\n    }\n\n    public void openTaskTray(String folder) {\n        if (initializationTaskOpened()) return;\n        openView(View.TaskTray);\n        if (taskTrayPage.taskTrayStamp != null) {\n            taskTrayPage.taskTrayStamp.folder(folder);\n            taskTrayPage.taskTrayStamp.refresh();\n        }\n    }\n\n    public void openTaskBoard(String folder) {\n        if (initializationTaskOpened()) return;\n        openView(View.TaskBoard);\n        if (taskBoardPage.taskBoardStamp != null) {\n            taskBoardPage.taskBoardStamp.folder(folder);\n            taskBoardPage.taskBoardStamp.refresh();\n        }\n    }\n\n    public void openNews() {\n        openView(View.News);\n        if (newsPage.newsStamp != null) newsPage.newsStamp.refresh();\n    }\n\n    public void openTrash() {\n        openView(View.Trash);\n        if (trashPage.trashStamp != null) trashPage.trashStamp.refresh();\n    }\n\n    private void refreshDrawer() {\n        Distribution distribution = BusinessUnit.getInstance().getDistribution();\n        Distribution.ShowProperty showProperty = distribution.getShow();\n        ")).output(expression().output(placeholder("definition", "refreshDrawer").multiple("\n"))).output(literal("\n        dashboard.visible(box().configuration().get(\"metabase-url\") != null && !box().configuration().get(\"metabase-url\").isEmpty() && AccountHelper.hasRoles(dashboardRoles(showProperty), session()));\n        roles.visible(showProperty.getTabRoles() != null && AccountHelper.hasRoles(showProperty.getTabRoles().getFor(), session()));\n        taskTray.visible(showProperty.getTabTasktray() != null && AccountHelper.hasRoles(showProperty.getTabTasktray().getFor(), session()));\n        if (taskTray.isVisible()) taskTray.value(AccountHelper.aliveTaskTrayTasksCount(session()));\n        taskBoard.visible(showProperty.getTabTaskboard() != null && AccountHelper.hasRoles(showProperty.getTabTaskboard().getFor(), session()));\n        if (taskBoard.isVisible()) taskBoard.value(AccountHelper.activeTaskBoardTasksCount(session()));\n        news.visible(showProperty.getTabNews() != null && AccountHelper.hasRoles(showProperty.getTabNews().getFor(), session()));\n        trash.visible(showProperty.getTabTrash() != null && AccountHelper.hasRoles(showProperty.getTabTrash().getFor(), session()));\n    }\n\n    ")).output(expression().output(placeholder("definition", "rolesMethod").multiple("\n"))).output(literal("\n    ")).output(expression().output(placeholder("definition", "setupAddressMethod").multiple("\n"))).output(literal("\n\n    private List<Ref> nodeDefinitionRoles(Distribution.ShowProperty showProperty, String code) {\n        NodeDefinition definition = showProperty.getTabEnvironment().stream().map(te -> org.monet.space.kernel.model.Dictionary.getInstance().getNodeDefinition(te.getValue())).filter(d -> d.getCode().equals(code)).findFirst().orElse(null);\n        if (definition == null) return null;\n        if (!definition.isEnvironment()) return null;\n\n        if (definition.isDesktop()) {\n            DesktopDefinition desktopDefinition = (DesktopDefinition) definition;\n            return desktopDefinition.getFor() != null ? desktopDefinition.getFor().getRole() : emptyList();\n        } else if (definition.isContainer() && definition.isEnvironment()) {\n            ContainerDefinition containerDefinition = (ContainerDefinition) definition;\n            return containerDefinition.getFor() != null ? containerDefinition.getFor().getRole() : emptyList();\n        }\n\n        return null;\n    }\n\n    private List<Ref> dashboardRoles(Distribution.ShowProperty showProperty) {\n        List<DashboardDefinition> definitionList = showProperty.getTabDashboard().stream().map(te -> org.monet.space.kernel.model.Dictionary.getInstance().getDashboardDefinition(te.getDefinition())).toList();\n        if (definitionList.isEmpty()) return null;\n        return definitionList.stream().map(DashboardDefinitionBase::getFor).filter(Objects::nonNull).map(f -> f.getRole().stream().toList()).flatMap(Collection::stream).distinct().toList();\n    }\n\n    private void openView(View view) {\n        loading.visible(false);\n        if (current == view) return;\n        if (current != null) blockOf(current).hide();\n        blockOf(view).show();\n        current = view;\n    }\n\n    private boolean initializationTaskOpened() {\n        Task task = io.intino.goros.unit.util.LayerHelper.taskLayer().getCurrentInitializerTask();\n        if (task == null) return false;\n        if (canResolveInitializerTask()) openInitializationTask(task.getId(), io.intino.goros.unit.box.ui.datasources.TaskListDatasource.Inbox.TaskBoard.name());\n        else openUpdateRequiredPage();\n        return true;\n    }\n\n    private void openUpdateRequiredPage() {\n        loading.visible(false);\n        updateRequiredPage.visible(true);\n    }\n\n    private boolean canResolveInitializerTask() {\n        FederationLayer federationLayer = io.intino.goros.unit.util.LayerHelper.federationLayer(session());\n        if (!federationLayer.isLogged()) return true;\n        TaskLayer taskLayer = io.intino.goros.unit.util.LayerHelper.taskLayer();\n        Task currentInitializerTask = taskLayer.getCurrentInitializerTask();\n        Account account = federationLayer.loadAccount();\n        return account.canResolveInitializerTask(currentInitializerTask);\n    }\n\n    private BlockConditional blockOf(View view) {\n        ")).output(expression().output(placeholder("definition", "block").multiple("\n"))).output(literal("\n        if (view == View.Dashboard) return dashboardPage;\n        if (view == View.Roles) return rolesPage;\n        if (view == View.TaskTray) return taskTrayPage;\n        if (view == View.TaskBoard) return taskBoardPage;\n        if (view == View.News) return newsPage;\n        if (view == View.Trash) return trashPage;\n        return null;\n    }\n\n    private boolean openInitializationTask(String id, String inbox) {\n        Task initializationTask = io.intino.goros.unit.util.LayerHelper.taskLayer().getCurrentInitializerTask();\n        if (initializationTask != null && (!initializationTask.getId().equals(id) || !canResolveInitializerTask())) {\n            openUpdateRequiredPage();\n            return false;\n        }\n        Task task = io.intino.goros.unit.util.LayerHelper.taskLayer().loadTask(id);\n        ")).output(expression().output(placeholder("definition", "taskInitialization").multiple("\n"))).output(literal("\n        return true;\n    }\n\n    private void refreshTasksCount(Task task) {\n        if (taskTray.isVisible()) taskTray.value(AccountHelper.aliveTaskTrayTasksCount(session()));\n        if (taskBoard.isVisible()) taskBoard.value(AccountHelper.activeTaskBoardTasksCount(session()));\n    }\n\n    private void initLoggedChecker() {\n        sessionClosedDialog.onClose(e -> sessionClosedDialogOpened = false);\n    }\n\n    private void checkFederation() {\n        try {\n            if (checkAgain() && !LayerHelper.federationLayer(session()).isLogged()) showSessionClosedDialog();\n            lastCheck = Instant.now();\n        }\n        catch (Throwable ignored) {\n            showSessionClosedDialog();\n        }\n    }\n\n    private boolean checkAgain() {\n        return lastCheck == null || Instant.now().toEpochMilli()-lastCheck.toEpochMilli() > 1_000;\n    }\n\n    private void showSessionClosedDialog() {\n        if (sessionClosedDialogOpened) return;\n        sessionClosedDialog.open();\n        sessionClosedDialogOpened = true;\n    }\n\n}")));
		rules.add(rule().condition(allTypes("ui", "header")).output(literal("package ")).output(placeholder("package")).output(literal(".")).output(placeholder("module", "lowerCase")).output(literal(".box.ui.displays.templates;\n\nimport ")).output(placeholder("package")).output(literal(".")).output(placeholder("module", "lowerCase")).output(literal(".box.")).output(placeholder("boxName", "firstUpperCase")).output(literal("Box;\nimport org.monet.metamodel.Distribution;\nimport org.monet.metamodel.Project;\nimport org.monet.space.kernel.Kernel;\nimport org.monet.space.kernel.exceptions.DataException;\nimport org.monet.space.kernel.model.BusinessUnit;\n\nimport java.io.File;\nimport java.net.MalformedURLException;\nimport java.net.URL;\n\npublic class HeaderTemplate extends AbstractHeaderTemplate<")).output(placeholder("boxName", "firstUpperCase")).output(literal("Box> {\n\n    public HeaderTemplate(")).output(placeholder("boxName", "firstUpperCase")).output(literal("Box box) {\n        super(box);\n    }\n\n    @Override\n    public void init() {\n        super.init();\n        BusinessUnit businessUnit = BusinessUnit.getInstance();\n        Distribution distribution = businessUnit.getDistribution();\n        Project project = businessUnit.getBusinessModel().getProject();\n        title.value(distribution != null ? BusinessUnit.getTitle(distribution, project) : \"\");\n        subtitle.value(businessUnit.getLabel());\n        logo.value(logo());\n        businessUnitsBlock.onOpen(e -> businessUnitsStamp.refresh());\n    }\n\n    private URL logo() {\n        try {\n            return new File(Kernel.getInstance().getConfiguration().getFederationLogoFile()).toURI().toURL();\n        } catch (DataException | MalformedURLException ignored) {\n            return HeaderTemplate.class.getResource(\"/images/logo.png\");\n        }\n    }\n}")));
		rules.add(rule().condition(all(allTypes("definition", "container", "environment"), trigger("openhome"))).output(literal("else if (AccountHelper.hasRoles(")).output(placeholder("name", "firstLowerCase")).output(literal("Roles(showProperty), session())) open")).output(placeholder("name", "firstUpperCase")).output(literal("(io.intino.goros.unit.util.NodeHelper.getEnvironmentNodeId(io.intino.goros.unit.util.AccountHelper.account(session()), \"")).output(placeholder("code")).output(literal("\"), null, true);")));
		rules.add(rule().condition(all(allTypes("definition", "desktop"), trigger("openhome"))).output(literal("else if (AccountHelper.hasRoles(")).output(placeholder("name", "firstLowerCase")).output(literal("Roles(showProperty), session())) open")).output(placeholder("name", "firstUpperCase")).output(literal("(true);")));
		rules.add(rule().condition(all(allTypes("definition", "container", "environment"), trigger("refreshdrawer"))).output(placeholder("name", "firstLowerCase")).output(literal("IconLink.address(this::setup")).output(placeholder("name", "firstUpperCase")).output(literal("Link);\n")).output(placeholder("name", "firstLowerCase")).output(literal("Link.address(this::setup")).output(placeholder("name", "firstUpperCase")).output(literal("Link);")));
		rules.add(rule().condition(all(allTypes("definition", "desktop"), trigger("refreshdrawer"))).output(placeholder("name", "firstLowerCase")).output(literal("IconLink.address(path -> path.replace(\":name\", \"")).output(placeholder("name", "lowercase")).output(literal("\").replace(\":mode\", \"default\"));\n")).output(placeholder("name", "firstLowerCase")).output(literal("Link.address(path -> path.replace(\":name\", \"")).output(placeholder("name", "lowercase")).output(literal("\").replace(\":mode\", \"default\"));\n")).output(placeholder("name", "firstLowerCase")).output(literal(".visible(AccountHelper.hasRoles(")).output(placeholder("name", "firstLowerCase")).output(literal("Roles(showProperty), session()));")));
		rules.add(rule().condition(all(allTypes("definition"), trigger("refreshdrawer"))));
		rules.add(rule().condition(all(allTypes("definition", "container", "environment"), trigger("rolesmethod"))).output(literal("private List<Ref> ")).output(placeholder("name", "firstLowerCase")).output(literal("Roles(Distribution.ShowProperty showProperty) {\n    return nodeDefinitionRoles(showProperty, \"")).output(placeholder("code")).output(literal("\");\n}")));
		rules.add(rule().condition(all(allTypes("definition", "desktop"), trigger("rolesmethod"))).output(literal("private List<Ref> ")).output(placeholder("name", "firstLowerCase")).output(literal("Roles(Distribution.ShowProperty showProperty) {\n    return nodeDefinitionRoles(showProperty, \"")).output(placeholder("code")).output(literal("\");\n}")));
		rules.add(rule().condition(all(allTypes("definition", "container", "environment"), trigger("setupaddressmethod"))).output(literal("private String setup")).output(placeholder("name", "firstUpperCase")).output(literal("Link(String path) {\n    String id = io.intino.goros.unit.util.NodeHelper.getEnvironmentNodeId(io.intino.goros.unit.util.AccountHelper.account(session()), \"")).output(placeholder("code")).output(literal("\");\n    return path.replace(\":name\", \"")).output(placeholder("name", "lowercase")).output(literal("\").replace(\":id\", id != null ? id : \"\").replace(\":view\", \"default\").replace(\":mode\", \"default\");\n}")));
		rules.add(rule().condition(all(allTypes("definition"), trigger("setupaddressmethod"))));
		rules.add(rule().condition(all(allTypes("definition"), trigger("rolesmethod"))));
		rules.add(rule().condition(all(allTypes("definition", "index"), trigger("declaration"))));
		rules.add(rule().condition(all(allTypes("definition"), trigger("declaration"))).output(placeholder("name", "firstUpperCase")));
		rules.add(rule().condition(all(allTypes("definition", "process"), trigger("method"))).output(literal("public void open")).output(placeholder("name", "firstUpperCase")).output(literal("(String task, String inbox) {\n    if (openInitializationTask(task, inbox)) return;\n    open")).output(placeholder("name", "firstUpperCase")).output(literal("(io.intino.goros.unit.util.LayerHelper.taskLayer().loadTask(task), inbox);\n}\n\nprivate void open")).output(placeholder("name", "firstUpperCase")).output(literal("(Task task, String inbox) {\n    openView(View.")).output(placeholder("name", "firstUpperCase")).output(literal(");\n    if (")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp != null) {\n        ")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp.inbox(io.intino.goros.unit.box.ui.datasources.TaskListDatasource.Inbox.from(inbox));\n        ")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp.open(task.getId());\n    }\n}")));
		rules.add(rule().condition(all(allTypes("definition", "index"), trigger("method"))));
		rules.add(rule().condition(all(allTypes("definition", "source"), trigger("method"))).output(literal("public void open")).output(placeholder("name", "firstUpperCase")).output(literal("() {\n    if (initializationTaskOpened()) return;\n    openView(View.")).output(placeholder("name", "firstUpperCase")).output(literal(");\n    if (")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp == null) return;\n    ")).output(expression().output(placeholder("sourceDesktop"))).output(literal("\n    ")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp.open(\"")).output(placeholder("code")).output(literal("\");\n}")));
		rules.add(rule().condition(allTypes("sourceDesktop")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp.desktop(\"")).output(placeholder("desktopLabel")).output(literal("\", \"/elemento/")).output(placeholder("desktop", "lowerCase")).output(literal("/default\");")));
		rules.add(rule().condition(all(allTypes("definition", "process"), trigger("taskinitialization"))).output(literal("if (task.getDefinition().getCode().equals(\"")).output(placeholder("code")).output(literal("\")) open")).output(placeholder("name", "firstUpperCase")).output(literal("(task, inbox);")));
		rules.add(rule().condition(all(allTypes("definition"), trigger("taskinitialization"))));
		rules.add(rule().condition(all(allTypes("definition", "singleton"), trigger("method"))).output(literal("public void open")).output(placeholder("name", "firstUpperCase")).output(literal("(boolean readonly) {\n    if (initializationTaskOpened()) return;\n    openView(View.")).output(placeholder("name", "firstUpperCase")).output(literal(");\n    if (")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp != null) {\n        ")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp.open(\"")).output(placeholder("code")).output(literal("\", readonly);\n    }\n}")));
		rules.add(rule().condition(all(allTypes("definition"), trigger("method"))).output(literal("public void open")).output(placeholder("name", "firstUpperCase")).output(literal("(String id, String view, boolean readonly) {\n    if (initializationTaskOpened()) return;\n    openView(View.")).output(placeholder("name", "firstUpperCase")).output(literal(");\n    if (")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp != null) {\n        ")).output(placeholder("name", "firstLowerCase")).output(literal("Page.")).output(placeholder("name", "firstLowerCase")).output(literal("Stamp.open(id, view, readonly);\n    }\n}")));
		rules.add(rule().condition(all(allTypes("definition", "process"), trigger("dispatchtask"))).output(literal("if (name.equalsIgnoreCase(\"")).output(placeholder("name")).output(literal("\")) display.open")).output(placeholder("name", "firstUpperCase")).output(literal("(task, inbox);")));
		rules.add(rule().condition(all(allTypes("definition"), trigger("dispatchtask"))));
		rules.add(rule().condition(all(allTypes("definition", "source"), trigger("dispatchsingleton"))).output(literal("if (name.equalsIgnoreCase(\"")).output(placeholder("name")).output(literal("\")) display.open")).output(placeholder("name", "firstUpperCase")).output(literal("();")));
		rules.add(rule().condition(all(allTypes("definition", "singleton"), trigger("dispatchsingleton"))).output(literal("if (name.equalsIgnoreCase(\"")).output(placeholder("name")).output(literal("\")) display.open")).output(placeholder("name", "firstUpperCase")).output(literal("(readonly);")));
		rules.add(rule().condition(all(allTypes("definition"), trigger("dispatchsingleton"))));
		rules.add(rule().condition(all(allTypes("definition", "source"), trigger("dispatchinstance"))));
		rules.add(rule().condition(all(allTypes("definition", "process"), trigger("dispatchinstance"))));
		rules.add(rule().condition(all(allTypes("definition", "singleton"), trigger("dispatchinstance"))));
		rules.add(rule().condition(all(allTypes("definition", "index"), trigger("dispatchinstance"))));
		rules.add(rule().condition(all(allTypes("definition"), trigger("dispatchinstance"))).output(literal("if (name.equalsIgnoreCase(\"")).output(placeholder("name")).output(literal("\")) display.open")).output(placeholder("name", "firstUpperCase")).output(literal("(id, view, readonly);")));
		rules.add(rule().condition(all(allTypes("definition", "index"), trigger("block"))));
		rules.add(rule().condition(all(allTypes("definition"), trigger("block"))).output(literal("if (view == View.")).output(placeholder("name", "firstUpperCase")).output(literal(") return ")).output(placeholder("name", "firstLowerCase")).output(literal("Page;")));
		return rules;
	}

	public String render(Object object) {
		return new io.intino.itrules.Engine(this).render(object);
	}

	public String render(Object object, java.util.Map<String, io.intino.itrules.Formatter> formatters) {
		return new io.intino.itrules.Engine(this).addAll(formatters).render(object);
	}
}