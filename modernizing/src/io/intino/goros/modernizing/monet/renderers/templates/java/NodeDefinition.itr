def type(nodedefinition & embedded)
    package $package.$module+lowerCase.box.ui.displays.templates;

    import $package.$module+lowerCase.box.$boxName+firstUpperCase~Box;
    import org.monet.space.kernel.model.Node;
    import org.monet.space.kernel.model.Revision;
    import io.intino.goros.unit.util.DisplayHelper;

    import java.util.List;

    public class $name+firstUpperCase~EmbeddedTemplate extends Abstract$name+firstUpperCase~EmbeddedTemplate<$boxName+firstUpperCase~Box> {
        private Node node;
        private Revision revision;
        private boolean readonly = false;
        [$toolbar+editableDeclaration]
        [$toolbar+navigableDeclaration]

        public $name+firstUpperCase~EmbeddedTemplate($boxName+firstUpperCase~Box box) {
            super(box);
        }

        public $name+firstUpperCase~EmbeddedTemplate node(Node node) {
            this.node = node;
            return this;
        }

        public $name+firstUpperCase~EmbeddedTemplate revision(org.monet.space.kernel.model.Revision revision) {
            this.revision = revision;
            return this;
        }

        public $name+firstUpperCase~EmbeddedTemplate readonly(boolean readonly) {
            this.readonly = readonly;
            return this;
        }

        public boolean editing() {
            return !readonly;
        }

        [$toolbar+editableEvents]
        [$toolbar+navigableEvents]
        [$toolbar+navigableMethods]

        public void openView(String view) {
            if (view == null) return;
            org.monet.metamodel.NodeViewProperty nodeView = node.getDefinition().getNodeView(view);
            if (nodeView == null) nodeView = node.getDefinition().getDefaultView();
            viewSelector.select(io.intino.goros.unit.util.DisplayHelper.translation(nodeView.getLabel()));
        }

        public String selectedView() {
            List<String> selection = viewSelector.selection();
            return selection.size() > 0 ? selection.get(0) : null;
        }

        public void selectDefaultView() {
            io.intino.goros.unit.util.DisplayHelper.selectDefaultView(viewSelector, node);
        }

        @Override
        public void init() {
            super.init();
            initToolbar();
            initViews();
        }

        @Override
        public void refresh() {
            super.refresh();
            if (revision != null) io.intino.goros.unit.util.DisplayHelper.selectNotSystemView(viewSelector, node);
            refreshToolbar();
            refreshViewsVisibility();
            refreshView();
        }

        private void refreshToolbar() {
            boolean readonly = node.isLocked() || this.readonly;
            restore.readonly(readonly);
            copy.visible(node.isPrototype());
            edit.title(readonly ? "Editar" : "Finalizar ediciÃ³n");
            edit.visible(!node.getDefinition().isReadonly() && !node.isLocked());
            [$toolbar+editableRefreshCall]
            [$toolbar+navigableRefreshCall]
        }

        private void refreshViewsVisibility() {
            String selectedView = selectedView();
            [$view+refreshVisibilityCall...[$NL]]
        }

        private void refreshView() {
            [$view+refreshCall...[$NL]]
        }

        private void initToolbar() {
            toolbar.visible(revision == null);
            restore.visible(revision != null);
            restore.onExecute(e -> restore());
            copy.onExecute(e -> copy());
            edit.onExecute(e -> toggleEdition());
            [$toolbar+editableInitCall]
            [$toolbar+navigableInitCall]
        }

        private void initViews() {
            [$view+initCall...[$NL]]
        }

        [$view+refreshMethod...[$NL]]

        private Node locateNode() {
            Node node = this.node;
            if (node == null) return null;
            if (revision != null) node = io.intino.goros.unit.util.LayerHelper.nodeLayer().loadNodeRevision(this.node.getId(), revision.getId());
            return node;
        }

        private void toggleEdition() {
            readonly(!readonly);
            [$toolbar+editableCall]
            refresh();
        }

        private void copy() {
            notifier.redirect(io.intino.goros.unit.util.PathHelper.pathOf(io.intino.goros.unit.util.NodeHelper.copyNode(node), language()));
        }

        private void restore() {
            io.intino.goros.unit.util.LayerHelper.nodeLayer().restoreNode(revision);
            notifier.redirect(session().browser().requestUrl());
        }

        [$toolbar+editableMethods]
    }
end

def type(nodedefinition & singleton)
    package $package.$module+lowerCase.box.ui.displays.templates;

    import $package.$module+lowerCase.box.$boxName+firstUpperCase~Box;
    import org.monet.space.kernel.model.Node;
    import io.intino.goros.unit.util.LayerHelper;

    public class $name+firstUpperCase~Template extends Abstract$name+firstUpperCase~Template<$boxName+firstUpperCase~Box> {
        private Node node;
        private boolean readonly = true;

        public $name+firstUpperCase~Template($boxName+firstUpperCase~Box box) {
            super(box);
        }

        public void open(String code) {
            node(LayerHelper.nodeLayer().locateNode(code));
            refresh();
        }

        public $name+firstUpperCase~Template node(Node node) {
            this.node = node;
            return this;
        }

        @Override
        public void init() {
            super.init();
            [$desktop]
            [$parent]
            [$toolbar+removeListener]
        }

        @Override
        public void refresh() {
            super.refresh();
            content.node(node);
            content.readonly(node.isLocked() || readonly);
            content.refresh();
            if (content.selectedView() == null) content.selectDefaultView();
        }

    }
end

def type(nodedefinition)
    package $package.$module+lowerCase.box.ui.displays.templates;

    import $package.$module+lowerCase.box.$boxName+firstUpperCase~Box;
    import org.monet.space.kernel.components.ComponentPersistence;
    import org.monet.space.kernel.model.Node;

    public class $name+firstUpperCase~Template extends Abstract$name+firstUpperCase~Template<$boxName+firstUpperCase~Box> {
        private Node node;
        private String view;

        public $name+firstUpperCase~Template($boxName+firstUpperCase~Box box) {
            super(box);
        }

        public $name+firstUpperCase~Template node(Node node) {
            this.node = node;
            return this;
        }

        public void open(String id, String view) {
            node(ComponentPersistence.getInstance().getNodeLayer().loadNode(id));
            this.view = view;
            refresh();
        }

        @Override
        public void refresh() {
            super.refresh();
            if (node == null) return;
            [$parent+refresh]
            refreshHeader(node);
            refreshContent(node);
        }

        private void refreshHeader(Node node) {
            label.value(node.getLabel());
        }

        private void refreshContent(Node node) {
            content.node(node);
            content.refresh();
            if (view != null) content.openView(view);
            else if (content.selectedView() == null) content.selectDefaultView();
        }
    }
end

def type(toolbar & singleton) trigger(editableInitCall)
    [$operation+editableInitCall...[$NL]]
end

def type(toolbar & collectable) trigger(navigableInitCall)
    showCollectionBack.onExecute(e -> notifyShowCollection());
    showCollectionMenu.onExecute(e -> notifyShowCollection());
end

def type(toolbar & singleton) trigger(editableRefreshCall)
    [$operation+editableRefreshCall...[$NL]]
end

def type(toolbar & singleton) trigger(editableEvents)
    public $definition+firstUpperCase~EmbeddedTemplate onFinishEdition(java.util.function.Consumer<Node> listener) {
        this.finishEditionListener = listener;
        return this;
    }
end

def type(toolbar & collectable) trigger(navigableEvents)
    public $definition+firstUpperCase~EmbeddedTemplate onShowCollection(java.util.function.Consumer<Node> listener) {
        this.showCollectionListener = listener;
        return this;
    }
end

def type(toolbar & singleton) trigger(editableMethods)
end

def type(toolbar & singleton) trigger(removeListener)
end

def type(toolbar & singleton) trigger(editableDeclaration)
    private java.util.function.Consumer<Node> finishEditionListener;
end

def type(toolbar & collectable) trigger(navigableDeclaration)
    private java.util.function.Consumer<Node> showCollectionListener;
end

def type(toolbar) trigger(editableDeclaration)
    private java.util.function.Consumer<Node> finishEditionListener;
    private java.util.function.Consumer<Node> removeListener;
end

def type(toolbar) trigger(editableInitCall)
    [$operation+editableInitCall...[$NL]]
    remove.onExecute(e -> removeNode());
end

def type(toolbar) trigger(editableRefreshCall)
    [$operation+editableRefreshCall...[$NL]]
    remove.visible(!readonly && !node.isSingleton() && !node.getDefinition().isReadonly());
end

def type(toolbar) trigger(editableCall)
    if (readonly && finishEditionListener != null) finishEditionListener.accept(node);
end

def type(toolbar) trigger(removeListener)
    content.onRemove(e -> PathHelper.dispatch(box().routeManager(), soul(), node.getMainNode()));
end

def type(toolbar) trigger(editableEvents)
    public $definition+firstUpperCase~EmbeddedTemplate onRemove(java.util.function.Consumer<Node> listener) {
        this.removeListener = listener;
        return this;
    }

    public $definition+firstUpperCase~EmbeddedTemplate onFinishEdition(java.util.function.Consumer<Node> listener) {
        this.finishEditionListener = listener;
        return this;
    }
end

def type(toolbar) trigger(editableMethods)
    private void removeNode() {
        String message = io.intino.goros.unit.util.NodeHelper.canRemove(node);
        if (message != null) {
            notifyUser(message, io.intino.alexandria.ui.displays.UserMessage.Type.Error);
            return;
        }
        io.intino.goros.unit.util.LayerHelper.nodeLayer().deleteNode(node);
        if (removeListener != null) removeListener.accept(node);
    }
end

def type(toolbar & collectable) trigger(navigableRefreshCall)
    label.value(node.getLabel());
    prototypeAdvise.visible(node.isPrototype());
    open.address(path -> path.replace(":name", "$definition").replace(":id", node.getId()));
end

def type(toolbar) trigger(navigableRefreshCall)
end

def type(toolbar & collectable) trigger(navigableMethods)
    public void bindTo(io.intino.alexandria.ui.displays.components.Collection collection) {
        previous.bindTo(collection);
        previous.visible(collection != null);
        next.bindTo(collection);
        next.visible(collection != null);
        open.visible(collection != null);
    }
    public void showLabel(boolean value) {
        label.visible(value);
    }
    public void showCollectionVisibility(io.intino.goros.unit.box.ui.ViewMode value) {
        showCollectionBack.visible(value == io.intino.goros.unit.box.ui.ViewMode.Full);
        showCollectionMenu.visible(value == io.intino.goros.unit.box.ui.ViewMode.Compact);
    }
    private void notifyShowCollection() {
        if (showCollectionListener == null) return;
        showCollectionListener.accept(node);
    }
end

def type(toolbar) trigger(navigableMethods)
end

def type(operation & download) trigger(editableInitCall)
    $name+lowerCase.onExecute(e -> io.intino.goros.unit.util.NodeHelper.downloadOperation($name+lowerCase, node, "$name"));
end

def type(operation & confirmation) trigger(editableInitCall)
    $name+lowerCase.onExecute(e -> io.intino.goros.unit.util.NodeHelper.executeOperation(box().routeManager().routeDispatcher(), session(), $name+lowerCase, node, "$name", translate("Operation executed")));
    $name+lowerCase.onBeforeAffirmed(e -> io.intino.goros.unit.util.NodeHelper.isOperationConfirmationRequired(node, "$name"));
    $name+lowerCase.onCancelAffirmed(e -> io.intino.goros.unit.util.NodeHelper.cancelOperation(box().routeManager().routeDispatcher(), session(), $name+lowerCase, node, "$name", translate("Operation canceled")));
end

def type(operation) trigger(editableInitCall)
    $name+lowerCase.onExecute(e -> io.intino.goros.unit.util.NodeHelper.executeOperation(box().routeManager().routeDispatcher(), session(), $name+lowerCase, node, "$name", translate("Operation executed")));
end

def type(operation) trigger(editableRefreshCall)
    $name+lowerCase.visible(io.intino.goros.unit.util.AccountHelper.hasRoles(io.intino.goros.unit.util.NodeHelper.operation(node, "$name"), session()) && !node.isPrototype());
end

def type(nodeview & visibleWhenEmbedded) trigger(initCall)
end

def type(nodeview) trigger(initCall)
    $name+firstLowerCase~View.onShow(e -> refresh$name+firstUpperCase~View());
end

def type(nodeview & visibleWhenEmbedded) trigger(refreshCall)
end

def type(nodeview) trigger(refreshCall)
    if ($name+firstLowerCase~View.isVisible()) refresh$name+firstUpperCase~View();
end

def type(nodeview & visibleWhenEmbedded) trigger(refreshVisibilityCall)
end

def type(nodeview & notVisibleOnRevision) trigger(refreshVisibilityCall)
    $name+firstLowerCase~View.visible(selectedView != null && selectedView.equals("$name+firstLowerCase") && revision == null);
end

def type(nodeview) trigger(refreshVisibilityCall)
    $name+firstLowerCase~View.visible(selectedView != null && selectedView.equals("$name+firstLowerCase"));
end

def type(nodeview & visibleWhenEmbedded) trigger(refreshMethod)
end

def type(nodeview) trigger(refreshMethod)
    private void refresh$name+firstUpperCase~View() {
        Node node = locateNode();
        if (node == null) return;
        [$contain+declaration]
        $name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.node(node);
        $name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.readonly(node.isLocked() || readonly);
        [$contain+call]
        $name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.view("$code");
        $name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.refresh();
        [$contain+open]
    }

    [$contain]
end

def type(contain) trigger(declaration)
    Node contain = $name+firstLowerCase~ViewContain(node);
end

def type(contain) trigger(call)
    $name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.contain(contain);
end

def type(contain) trigger(open)
    if (contain != null) openContain.address(path -> path.replace(":name", "$containName").replace(":id", contain.getId()));
    openContain.visible(contain != null && contain.isSet());
end

def type(contain)
    private Node $name+firstLowerCase~ViewContain(Node node) {
        if (this.revision != null) return io.intino.goros.unit.util.LayerHelper.nodeLayer().loadNodeRevision(io.intino.goros.unit.util.NodeHelper.getContainerContain(node, "$contain"), revision.getId());
        return io.intino.goros.unit.util.LayerHelper.nodeLayer().loadNode(io.intino.goros.unit.util.NodeHelper.getContainerContain(node,"$contain"));
    }
end

def type(nodeView)
    package $package.$module+lowerCase.box.ui.displays.templates;

    import $package.$module+lowerCase.box.$boxName+firstUpperCase~Box;
    import io.intino.alexandria.ui.displays.events.actionable.ToggleEvent;
    import org.monet.bpi.*;
    import org.monet.space.kernel.model.Node;
    import io.intino.goros.unit.box.ui.datasources.FormDatasource;

    import java.util.function.Consumer;

    import static java.util.stream.Collectors.toList;

    public class $definition+firstUpperCase~$name+firstUpperCase~ViewTemplate extends Abstract$definition+firstUpperCase~$name+firstUpperCase~ViewTemplate<$boxName+firstUpperCase~Box>[ implements $implements] {
        private Node node;
        private String view;
        private boolean readonly = false;
        $show+declaration

        public $definition+firstUpperCase~$name+firstUpperCase~ViewTemplate($boxName+firstUpperCase~Box box) {
            super(box);
        }

        public $definition+firstUpperCase~$name+firstUpperCase~ViewTemplate node(Node node) {
            this.node = node;
            $updateFields+call
            return this;
        }

        public String view() {
            return this.view;
        }

        public $definition+firstUpperCase~$name+firstUpperCase~ViewTemplate view(String view) {
            this.view = view;
            return this;
        }

        public $definition+firstUpperCase~$name+firstUpperCase~ViewTemplate readonly(boolean readonly) {
            this.readonly = readonly;
            return this;
        }

        public boolean editing() {
            return !readonly;
        }

        $show
        [$displayProvider]
    }
end

def type(updateFields) trigger(call)
    updateFields();
end

def type(show & recenttask) trigger(declaration)
    private org.monet.space.kernel.model.Task<?> task;
end

def type(show & recenttask)
    @Override
    public void init() {
        super.init();
        initToolbar();
        initViews();
    }

	private void initToolbar() {
		toolbar.onUpdate(task -> refresh());
		toolbar.onChange(e -> refresh());
		toolbar.onAbort(e -> refresh());
	}

	private void initViews() {
	    [$tasktype+initCall...[$NL]]
	}

	@Override
	public void refresh() {
		super.refresh();
		task = io.intino.goros.unit.util.NodeHelper.recentTask(node, view);
		noTaskMessage.visible(task == null);
		viewsBlock.visible(task != null);
		refreshToolbar();
		showView();
	}

	private void refreshToolbar() {
		boolean visible = task != null;
		toolbarBlock.visible(visible);
		if (!visible) return;
		toolbar.task(task);
		toolbar.readonly(readonly);
		toolbar.refresh();
	}

	private void showView() {
	    hideViews();
	    if (task == null) return;
	    String code = task.getCode();
	    [$tasktype+showCall...[$NL]]
	}

	private void hideViews() {
        [$tasktype+hideCall...[$NL]]
	}

    [$tasktype+refreshMethod...[$NL]]
end

def type(tasktype) trigger(initCall)
    $name+firstLowerCase~View.onShow(e -> refresh$name+firstUpperCase~View(task));
end

def type(tasktype) trigger(showCall)
    if (code.equals("$code")) $name+firstLowerCase~View.show();
end

def type(tasktype) trigger(hideCall)
    $name+firstLowerCase~View.hide();
end

def type(tasktype) trigger(refreshMethod)
	private void refresh$name+firstUpperCase~View(org.monet.space.kernel.model.Task<?> task) {
		$name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.task(task);
		$name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.readonly(readonly);
		$name+firstLowerCase~View.$name+firstLowerCase~ViewStamp.refresh();
	}
end

def type(show & revisions) trigger(declaration)
end

def type(show & revisions)
	@Override
	public void refresh() {
		super.refresh();
		revisionsStamp.node(node);
		revisionsStamp.readonly(node.isLocked() || readonly);
		revisionsStamp.onSelect(this::openRevision);
		revisionsStamp.refresh();
	}

	private void openRevision(org.monet.space.kernel.model.Revision revision) {
		selectRevisionPage.visible(false);
		revisionPage.visible(true);
		currentRevisionStamp.node(node);
		currentRevisionStamp.revision(revision);
		currentRevisionStamp.readonly(node.isLocked() || readonly);
		currentRevisionStamp.refresh();
	}
end

def type(desktop)
    desktopLink.address(path -> path.replace(":name", "$name+lowerCase"));
end

def type(parent) trigger(refresh)
    parentLink.address(path -> path.replace(":name", io.intino.goros.unit.util.NodeHelper.nameOf(node.getParent())));
    parentLink.title(node.getParent() != null ? node.getParent().getLabel() : "Inicio");
end

def type(parent)
    parentLink.address(path -> path.replace(":name", "$name+lowerCase"));
end